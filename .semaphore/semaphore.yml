version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  queued:
    when: 'true'
fail_fast:
  stop:
    when: 'true'
blocks:
  - name: Install deps
    task:
      jobs:
        - name: Bundle
          commands:
            - ls -l
            - echo test > olga.txt
            - ls -l
    dependencies: []
  - name: Unit tests
    dependencies:
      - Install deps
    task:
      jobs:
        - name: RSpec
          commands: []
          parallelism: 3
  - name: Static analysis
    dependencies:
      - Unit tests
    task:
      jobs:
        - name: Lint
          commands:
            - echo
        - name: 'Job #2'
          commands:
            - sleep 10
  - name: Acceptance tests
    dependencies:
      - Unit tests
    task:
      jobs:
        - name: Cucumber
          commands:
            - checkout
            - sleep 10
          parallelism: 3
  - name: Make screenshot
    dependencies:
      - Install deps
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - pwd
            - '/usr/bin/google-chrome --headless --screenshot="home_2.png" "https://semaphoreci.com"'
            - artifact push workflow home_2.png
  - name: Fetch artifact
    dependencies:
      - Make screenshot
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - artifact pull workflow home_2.png
promotions:
  - name: Production deploy
    pipeline_file: pipeline_2.yml
    parameters:
      env_vars:
        - required: false
          options: []
          description: Random string
          name: NEW_STR
        - required: true
          options:
            - Stage
            - Production
          default_value: Stage
          description: Where to deploy?
          name: ENVIRONMENT
    auto_promote:
      when: branch = 'main' AND result = 'passed'
  - name: Deploy to staging
    pipeline_file: pipeline_3.yml
    auto_promote:
      when: branch = 'dev' AND result = 'passed'
